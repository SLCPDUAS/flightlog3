<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flight Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
body{margin:0;font-family:system-ui;background:#000;color:#fff}
header{background:#111;padding:15px;text-align:center}
section{padding:15px}
.card{background:#1c1c1e;padding:15px;border-radius:10px;margin-bottom:15px}
button{padding:12px;border:none;border-radius:8px;font-weight:600;width:100%;margin-top:8px}
.start{background:#34c759}
.stop{background:#ff3b30}
.reset{background:#8e8e93}
input,select,textarea{
 width:100%;padding:10px;border-radius:6px;
 border:1px solid #333;background:#2c2c2e;color:#fff
}
.timer{font-size:2.6em;text-align:center;margin-bottom:10px}
#map{height:300px;border-radius:10px}
.flight{border-left:4px solid #667eea;padding-left:10px;margin-bottom:12px}
</style>
</head>

<body>

<header>
<h2>✈️ Flight Tracker</h2>
<p>Randy Neal</p>
</header>

<section>

<div class="card">
<div id="timer" class="timer">00:00:00</div>
<button class="start" onclick="startTimer()">Start</button>
<button class="stop" onclick="stopTimer()">Stop</button>
<button class="reset" onclick="resetTimer()">Reset</button>
</div>

<div class="card">
<select id="drone">
<option value="">Select Drone</option>
<option>Skyrover S1</option>
<option>Skydio X10-1</option>
<option>Skydio X10-2.2</option>
<option>Skydio X10-3</option>
<option>Skydio X10-4</option>
<option>Skydio X10-5</option>
</select>
<input id="address" placeholder="Auto-filled from GPS">
<textarea id="purpose" placeholder="Flight purpose"></textarea>
<button onclick="saveFlight()">Save Flight</button>
</div>

<div class="card">
<h3>Map</h3>
<div id="map"></div>
</div>

<div class="card">
<h3>Weather</h3>
<div id="weather">Waiting for GPS…</div>
</div>

<div class="card">
<h3>Flight History</h3>
<div id="history"></div>
</div>

</section>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ---------------- TIMER ---------------- */
let interval=null, elapsed=0, startISO=null;

function renderTimer(){
 const h=String(Math.floor(elapsed/3600)).padStart(2,'0');
 const m=String(Math.floor((elapsed%3600)/60)).padStart(2,'0');
 const s=String(elapsed%60).padStart(2,'0');
 timer.textContent=`${h}:${m}:${s}`;
}

function startTimer(){
 if(interval) return;
 startISO=new Date().toISOString();
 interval=setInterval(()=>{elapsed++;renderTimer();},1000);
}

function stopTimer(){
 clearInterval(interval);
 interval=null;
}

function resetTimer(){
 stopTimer();
 elapsed=0;
 startISO=null;
 renderTimer();
}

/* ---------------- MAP + GPS ---------------- */
let map, marker, lat=null, lng=null;

navigator.geolocation.getCurrentPosition(pos=>{
 lat=pos.coords.latitude;
 lng=pos.coords.longitude;

 map=L.map('map');
 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
 map.setView([lat,lng],16);
 marker=L.marker([lat,lng]).addTo(map);
 map.invalidateSize();

 reverseGeocode(lat,lng);
 loadWeather(lat,lng);
},()=>alert("GPS permission required"));

/* ---------------- GOOGLE GEOCODING ---------------- */
const GOOGLE_KEY="AIzaSyB76-DcQwEsU4Q1S-aHKf11-VceYQnu5Zw";

function reverseGeocode(lat,lng){
 fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${GOOGLE_KEY}`)
 .then(r=>r.json())
 .then(d=>{
  if(d.results?.[0]) address.value=d.results[0].formatted_address;
 });
}

/* ---------------- WEATHER ---------------- */
function loadWeather(lat,lng){
 fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,wind_speed_10m`)
 .then(r=>r.json())
 .then(d=>{
  weather.innerHTML=
   `Temp: ${d.current.temperature_2m}°F<br>
    Wind: ${d.current.wind_speed_10m} mph`;
 });
}

/* ---------------- STORAGE ---------------- */
function saveFlight(){
 if(!drone.value) return alert("Select drone");

 const flights=JSON.parse(localStorage.getItem("flights")||"[]");

 flights.unshift({
  drone:drone.value,
  address:address.value,
  purpose:purpose.value,
  duration:timer.textContent,
  start:startISO,
  end:new Date().toISOString()
 });

 localStorage.setItem("flights",JSON.stringify(flights));
 resetTimer();
 renderHistory();
}

function deleteFlight(i){
 const flights=JSON.parse(localStorage.getItem("flights"));
 flights.splice(i,1);
 localStorage.setItem("flights",JSON.stringify(flights));
 renderHistory();
}

function renderHistory(){
 const flights=JSON.parse(localStorage.getItem("flights")||"[]");
 history.innerHTML=flights.length?flights.map((f,i)=>`
  <div class="flight">
   <b>${f.drone}</b><br>
   ${f.address||'Unknown location'}<br>
   Duration: ${f.duration}<br>
   <button onclick="deleteFlight(${i})">Delete</button>
  </div>`).join(""):"No flights yet";
}

renderTimer();
renderHistory();
</script>

</body>
</html>
