<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Flight Tracker">
<title>Randy Neal Flight Tracker</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
/* Basic Styles */
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #000;
  color: #fff;
  overflow-x: hidden;
  user-select: none;
}
.status-bar {
  height: 44px;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  border-bottom: 1px solid #333;
}
.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
  text-align: center;
}
.header h1 { font-size: 1.4em; margin-bottom: 5px; }
.header p { font-size: 0.85em; opacity: 0.9; }
.tabs {
  display: flex;
  background: #1c1c1e;
  border-bottom: 1px solid #333;
}
.tab {
  flex: 1;
  padding: 15px;
  text-align: center;
  border: none;
  background: none;
  color: #8e8e93;
  font-size: 0.9em;
  cursor: pointer;
  transition: all 0.3s;
}
.tab.active {
  color: #fff;
  border-bottom: 2px solid #667eea;
}
.content {
  padding: 20px;
  display: none;
}
.content.active { display: block; }
.card {
  background: #1c1c1e;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  border: 1px solid #2c2c2e;
}
.card h3 {
  color: #667eea;
  margin-bottom: 10px;
  font-size: 1.1em;
}
.input-group {
  margin-bottom: 15px;
}
.input-group label {
  display: block;
  color: #8e8e93;
  font-size: 0.85em;
  margin-bottom: 5px;
}
.input-group input,
.input-group select,
.input-group textarea {
  width: 100%;
  padding: 12px;
  background: #2c2c2e;
  border: 1px solid #3a3a3c;
  border-radius: 8px;
  color: #fff;
  font-size: 16px;
}
.input-group textarea {
  resize: vertical;
  min-height: 60px;
}
.btn {
  width: 100%;
  padding: 15px;
  border: none;
  border-radius: 10px;
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  margin-top: 10px;
}
.btn-start { background: #34c759; color: #fff; }
.btn-stop { background: #ff3b30; color: #fff; }
.btn-primary { background: #667eea; color: #fff; }
.btn-secondary { background: #3a3a3c; color: #fff; }
.timer {
  font-size: 3em;
  text-align: center;
  font-weight: 300;
  padding: 30px 0;
  font-variant-numeric: tabular-nums;
}
.weather-info {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 10px;
}
.weather-item {
  background: #2c2c2e;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
}
.weather-item .label {
  color: #8e8e93;
  font-size: 0.8em;
  margin-bottom: 5px;
}
.weather-item .value {
  font-size: 1.3em;
  font-weight: 600;
}
.flight-log-item {
  background: #2c2c2e;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 10px;
  border-left: 4px solid #667eea;
}
.flight-log-item.offline {
  border-left-color: #ff9500;
}
.flight-log-item h4 {
  margin-bottom: 8px;
  color: #667eea;
}
.flight-log-item p {
  color: #8e8e93;
  font-size: 0.85em;
  margin: 3px 0;
}
.maintenance-item {
  background: #2c2c2e;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 10px;
}
.maintenance-item h4 {
  color: #fff;
  margin-bottom: 5px;
}
.maintenance-item p {
  color: #8e8e93;
  font-size: 0.85em;
}
.status-indicator {
  display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-right: 8px;
}
.status-online { background: #34c759; }
.status-offline { background: #ff9500; }
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #8e8e93;
}
.badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75em;
  font-weight: 600;
  margin-left: 8px;
}
.badge-offline { background: #ff9500; color: #000; }
.badge-synced { background: #34c759; color: #000; }

/* Map container */
#map { height: 300px; width: 100%; margin-top: 10px; border-radius: 12px; border: 1px solid #2c2c2e; }
</style>

</head>
<body>

<div class="status-bar">
  <span id="connectionStatus">
    <span class="status-indicator status-online"></span>
    Online
  </span>
</div>

<div class="header">
  <h1>✈️ Flight Tracker</h1>
  <p>Randy Neal | License #52082259</p>
</div>

<div class="tabs">
  <button class="tab active" onclick="switchTab('flight')">Flight</button>
  <button class="tab" onclick="switchTab('history')">History</button>
  <button class="tab" onclick="switchTab('maintenance')">Maintenance</button>
</div>

<!-- FLIGHT TAB -->
<div id="flight-content" class="content active">
  <div class="card">
    <h3>Flight Timer</h3>
    <div class="timer" id="timer">00:00:00</div>
    <button id="startStopBtn" class="btn btn-start" onclick="toggleFlight()">Start Flight</button>
  </div>

  <div class="card">
    <h3>Flight Details</h3>
    <div class="input-group">
      <label>Drone Type</label>
      <select id="droneType">
        <option value="">Select Drone</option>
        <option value="DJI Mavic PT 30T #1">DJI Mavic PT 30T #1</option>
        <option value="DJI Mavic 3T #1.2">DJI Mavic 3T #1.2</option>
        <option value="DJI Mavic 3T #2.1">DJI Mavic 3T #2.1</option>
        <option value="DJI Mavic 3T #3">DJI Mavic 3T #3</option>
        <option value="DJI Mavic 3E #1">DJI Mavic 3E #1</option>
        <option value="DJI Mini 3 Pro #1">DJI Mini 3 Pro #1</option>
        <option value="DJI Mini 3 Pro #2">DJI Mini 3 Pro #2</option>
        <option value="DJI Avata Patrol #1">DJI Avata Patrol #1</option>
        <option value="Autel 640T V3 #1">Autel 640T V3 #1</option>
        <option value="Skydio X2E">Skydio X2E</option>
        <option value="DJI Matrice 4T-1">DJI Matrice 4T-1</option>
        <option value="DJI Matrice 4T-2">DJI Matrice 4T-2</option>
        <option value="DJI Matrice 4T-3">DJI Matrice 4T-3</option>
      </select>
    </div>

    <div class="input-group">
      <label>Location</label>
      <input type="text" id="location" placeholder="Enter location">
    </div>

    <div class="input-group">
      <label>LAANC Authorization</label>
      <input type="text" id="laanc" placeholder="Authorization number (optional)">
    </div>

    <div class="input-group">
      <label>Flight Purpose</label>
      <textarea id="purpose" placeholder="Describe flight purpose..."></textarea>
    </div>

    <div class="card">
      <h3>Flight Map</h3>
      <div id="map"></div>
    </div>
  </div>

  <div class="card">
    <h3>Weather Conditions</h3>
    <button class="btn btn-secondary" onclick="getWeather()">Refresh Weather</button>
    <div class="weather-info" id="weatherInfo">
      <div class="weather-item">
        <div class="label">Temperature</div>
        <div class="value" id="temp">--°F</div>
      </div>
      <div class="weather-item">
        <div class="label">Wind Speed</div>
        <div class="value" id="wind">-- mph</div>
      </div>
      <div class="weather-item">
        <div class="label">Humidity</div>
        <div class="value" id="humidity">--%</div>
      </div>
      <div class="weather-item">
        <div class="label">Conditions</div>
        <div class="value" id="conditions">--</div>
      </div>
    </div>
  </div>
</div>

<!-- HISTORY TAB -->
<div id="history-content" class="content">
  <div class="card">
    <h3>Flight History</h3>
    <button class="btn btn-primary" onclick="syncOfflineFlights()">Sync Offline Flights</button>
    <button class="btn btn-secondary" onclick="exportFlights()">Export CSV</button>
  </div>
  <div id="historyList"></div>
</div>

<!-- MAINTENANCE TAB -->
<div id="maintenance-content" class="content">
  <div class="card">
    <h3>Add Maintenance Log</h3>
    <div class="input-group">
      <label>Drone</label>
      <select id="maintDrone">
        <option value="">Select Drone</option>
        <option value="DJI Mavic PT 30T #1">DJI Mavic PT 30T #1</option>
        <option value="DJI Mavic 3T #1.2">DJI Mavic 3T #1.2</option>
        <option value="DJI Mavic 3T #2.1">DJI Mavic 3T #2.1</option>
        <option value="DJI Mavic 3T #3">DJI Mavic 3T #3</option>
        <option value="DJI Mavic 3E #1">DJI Mavic 3E #1</option>
        <option value="DJI Mini 3 Pro #1">DJI Mini 3 Pro #1</option>
        <option value="DJI Mini 3 Pro #2">DJI Mini 3 Pro #2</option>
        <option value="DJI Avata Patrol #1">DJI Avata Patrol #1</option>
        <option value="Autel 640T V3 #1">Autel 640T V3 #1</option>
        <option value="Skydio X2E">Skydio X2E</option>
        <option value="DJI Matrice 4T-1">DJI Matrice 4T-1</option>
        <option value="DJI Matrice 4T-2">DJI Matrice 4T-2</option>
        <option value="DJI Matrice 4T-3">DJI Matrice 4T-3</option>
      </select>
    </div>
    <div class="input-group">
      <label>Maintenance Type</label>
      <select id="maintType">
        <option value="Inspection">Pre-flight Inspection</option>
        <option value="Battery">Battery Maintenance</option>
        <option value="Propeller">Propeller Replacement</option>
        <option value="Firmware">Firmware Update</option>
        <option value="Calibration">Sensor Calibration</option>
        <option value="Cleaning">Cleaning</option>
        <option value="Repair">Repair</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="input-group">
      <label>Notes</label>
      <textarea id="maintNotes" placeholder="Maintenance details..."></textarea>
    </div>
    <button class="btn btn-primary" onclick="addMaintenance()">Log Maintenance</button>
  </div>
  <div id="maintenanceList"></div>
</div>

<!-- Leaflet CSS for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
 integrity="sha256-sA+4rRfv6kVtJdAtHkt0n6GqF0ujkK+ZyVqVGH5f0Jw=" crossorigin=""/>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

let app, db;
try {
  app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  console.log("Firebase initialized");
} catch (error) {
  console.error("Firebase init error:", error);
}

// ----- GLOBAL STATE -----
window.appState = {
  isOnline: navigator.onLine,
  flights: [],
  maintenance: [],
  currentFlight: null,
  timerInterval: null,
  startTime: null,
  map: null,
  markers: []
};

// ----- CONNECTION STATUS -----
function updateConnectionStatus() {
  const statusEl = document.getElementById('connectionStatus');
  if (window.appState.isOnline) {
    statusEl.innerHTML = '<span class="status-indicator status-online"></span>Online';
  } else {
    statusEl.innerHTML = '<span class="status-indicator status-offline"></span>Offline';
  }
}
window.addEventListener('online', () => {
  window.appState.isOnline = true;
  updateConnectionStatus();
  syncOfflineFlights();
});
window.addEventListener('offline', () => {
  window.appState.isOnline = false;
  updateConnectionStatus();
});

// ----- OFFLINE DATA -----
function loadOfflineData() {
  const offlineFlights = localStorage.getItem('offlineFlights');
  return offlineFlights ? JSON.parse(offlineFlights) : [];
}
function saveOfflineFlight(flight) {
  const offlineFlights = loadOfflineData();
  offlineFlights.push(flight);
  localStorage.setItem('offlineFlights', JSON.stringify(offlineFlights));
}

// ----- SYNC OFFLINE -----
window.syncOfflineFlights = async function() {
  if (!window.appState.isOnline) { alert('Cannot sync while offline'); return; }
  const offlineFlights = loadOfflineData();
  if (offlineFlights.length === 0) { alert('No offline flights to sync'); return; }
  try {
    for (const flight of offlineFlights) { await addDoc(collection(db, "flights"), flight); }
    localStorage.removeItem('offlineFlights');
    alert(`Synced ${offlineFlights.length} offline flight(s)`);
    loadFlights();
  } catch (e) { alert('Error syncing flights: ' + e.message); }
};

// ----- FLIGHT TIMER -----
window.toggleFlight = function() { window.appState.currentFlight ? stopFlight() : startFlight(); };

function startFlight() {
  const droneType = document.getElementById('droneType').value;
  const location = document.getElementById('location').value;
  if (!droneType || !location) { alert('Please select drone type and enter location'); return; }
  window.appState.startTime = Date.now();
  window.appState.currentFlight = {
    droneType,
    location,
    laanc: document.getElementById('laanc').value,
    purpose: document.getElementById('purpose').value,
    startTime: new Date().toISOString(),
    pilot: "Randy Neal",
    path: []
  };
  document.getElementById('startStopBtn').textContent = "Stop Flight";
  document.getElementById('startStopBtn').classList.remove('btn-start');
  document.getElementById('startStopBtn').classList.add('btn-stop');
  window.appState.timerInterval = setInterval(updateTimer, 1000);
  startGeolocation();
}

function stopFlight() {
  clearInterval(window.appState.timerInterval);
  const flight = window.appState.currentFlight;
  if (!flight) return;
  flight.endTime = new Date().toISOString();
  flight.duration = Math.floor((Date.now() - window.appState.startTime)/1000);
  if (window.appState.isOnline && db) {
    addDoc(collection(db, "flights"), flight).catch(() => saveOfflineFlight(flight));
  } else { saveOfflineFlight(flight); }
  window.appState.currentFlight = null;
  document.getElementById('timer').textContent = "00:00:00";
  document.getElementById('startStopBtn').textContent = "Start Flight";
  document.getElementById('startStopBtn').classList.remove('btn-stop');
  document.getElementById('startStopBtn').classList.add('btn-start');
  loadFlights();
}

// ----- TIMER DISPLAY -----
function updateTimer() {
  if (!window.appState.startTime) return;
  const s = Math.floor((Date.now() - window.appState.startTime)/1000);
  document.getElementById('timer').textContent =
    String(Math.floor(s/3600)).padStart(2,'0')+":"+
    String(Math.floor((s%3600)/60)).padStart(2,'0')+":"+
    String(s%60).padStart(2,'0');
}

// ----- GEOLOCATION -----
function startGeolocation() {
  if (!navigator.geolocation) return alert('Geolocation not supported');
  window.appState.geoWatch = navigator.geolocation.watchPosition(pos => {
    const p = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy };
    if (p.acc > 25) return; // skip inaccurate
    if (window.appState.currentFlight) window.appState.currentFlight.path.push(p);
    updateMap(p);
  }, err => console.warn(err), { enableHighAccuracy:true, maximumAge:0, timeout:8000 });
}

// ----- MAP -----
import L from "https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js";
window.appState.map = L.map('map').setView([37.7749,-122.4194], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:18 }).addTo(window.appState.map);
function updateMap(pos) {
  const map = window.appState.map;
  if (!map) return;
  const marker = L.circleMarker([pos.lat,pos.lng], { radius: 6, color:'#34c759' }).addTo(map);
  window.appState.markers.push(marker);
  map.panTo([pos.lat,pos.lng]);
}

// ----- WEATHER -----
window.getWeather = async function() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(async pos => {
    try {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const key = "YOUR_OPENWEATHERMAP_API_KEY";
      const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${key}&units=imperial`);
      const data = await res.json();
      document.getElementById('temp').textContent = `${data.main.temp}°F`;
      document.getElementById('wind').textContent = `${data.wind.speed} mph`;
      document.getElementById('humidity').textContent = `${data.main.humidity}%`;
      document.getElementById('conditions').textContent = data.weather[0].description;
    } catch(e){ console.warn(e); }
  });
};

// ----- FLIGHT HISTORY -----
function loadFlights() {
  const historyList = document.getElementById('historyList');
  historyList.innerHTML = '';
  const offlineFlights = loadOfflineData();
  offlineFlights.forEach(f => renderFlight(f,true));
  if (db && window.appState.isOnline) {
    const q = query(collection(db,"flights"), orderBy("startTime","desc"));
    onSnapshot(q,snap=>{
      snap.docChanges().forEach(change=>{
        if (change.type==='added') renderFlight(change.doc.data(),false);
      });
    });
  }
}
function renderFlight(flight,offline=false) {
  const el = document.createElement('div');
  el.className = 'flight-log-item'+(offline?' offline':'');
  el.innerHTML = `
    <h4>${flight.droneType} <span class="badge ${offline?'badge-offline':'badge-synced'}">${offline?'Offline':'Synced'}</span></h4>
    <p><strong>Location:</strong> ${flight.location}</p>
    <p><strong>Purpose:</strong> ${flight.purpose || '--'}</p>
    <p><strong>Start:</strong> ${new Date(flight.startTime).toLocaleString()}</p>
    <p><strong>End:</strong> ${flight.endTime ? new Date(flight.endTime).toLocaleString():'--'}</p>
    <p><strong>Duration:</strong> ${flight.duration?flight.duration+' sec':'--'}</p>
  `;
  document.getElementById('historyList').prepend(el);
}

// ----- MAINTENANCE -----
window.addMaintenance = function() {
  const drone = document.getElementById('maintDrone').value;
  const type = document.getElementById('maintType').value;
  const notes = document.getElementById('maintNotes').value;
  if (!drone || !type) return alert('Select drone and type');
  const log = { drone, type, notes, time: new Date().toISOString() };
  const list = JSON.parse(localStorage.getItem('maintenance')||'[]');
  list.push(log);
  localStorage.setItem('maintenance', JSON.stringify(list));
  renderMaintenance();
  document.getElementById('maintNotes').value='';
}
function renderMaintenance() {
  const container = document.getElementById('maintenanceList');
  const list = JSON.parse(localStorage.getItem('maintenance')||'[]');
  container.innerHTML = '';
  if (!list.length) { container.innerHTML='<div class="empty-state">No maintenance logs yet</div>'; return; }
  list.forEach(log=>{
    const el = document.createElement('div');
    el.className = 'maintenance-item';
    el.innerHTML = `<h4>${log.drone}</h4><p><strong>${log.type}</strong></p><p>${log.notes}</p><p>${new Date(log.time).toLocaleString()}</p>`;
    container.appendChild(el);
  });
}
renderMaintenance();
loadFlights();

// ----- TABS -----
window.switchTab = function(tab) {
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.getElementById(tab+'-content').classList.add('active');
  document.querySelector('.tab[onclick="switchTab(\''+tab+'\')"]').classList.add('active');
}

// ----- CSV EXPORT -----
window.exportFlights = function() {
  let data = loadOfflineData();
  if (db && window.appState.isOnline) data = data.concat(window.appState.flights);
  if (!data.length) return alert('No flights to export');
  const csv = data.map(f=>[
    f.startTime,f.endTime,f.droneType,f.location,f.purpose,f.laanc,f.duration
  ].join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'flights.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// ----- SERVICE WORKER FOR PWA -----
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE = 'flight-tracker-v2';
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['/'])));
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch', e=>{
      e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
    });
  `;
  const blob = new Blob([swCode], {type:'text/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
}
</script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</body>
</html>
