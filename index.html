<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flight Tracker</title>
<meta name="description" content="Drone Flight Tracker PWA">
<link rel="manifest" href="manifest.json">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:#000; color:#fff; }
.header { text-align:center; padding:20px; background:linear-gradient(135deg,#667eea,#764ba2); }
.header h1 { font-size:1.5em; }
.tabs { display:flex; background:#1c1c1e; }
.tab { flex:1; padding:15px; text-align:center; cursor:pointer; color:#8e8e93; border-bottom:2px solid transparent; }
.tab.active { color:#fff; border-bottom:2px #667eea solid; }
.content { padding:20px; display:none; }
.content.active { display:block; }
.card { background:#1c1c1e; border-radius:12px; padding:15px; margin-bottom:15px; border:1px solid #2c2c2e; }
.input-group { margin-bottom:15px; }
.input-group label { display:block; color:#8e8e93; margin-bottom:5px; font-size:0.85em; }
.input-group input, .input-group select, .input-group textarea { width:100%; padding:12px; background:#2c2c2e; border:1px solid #3a3a3c; border-radius:8px; color:#fff; font-size:16px; }
.input-group textarea { resize:vertical; min-height:60px; }
.btn { width:100%; padding:15px; border:none; border-radius:10px; font-size:1em; font-weight:600; cursor:pointer; margin-top:10px; }
.btn-start { background:#34c759; color:#fff; }
.btn-stop { background:#ff3b30; color:#fff; }
.btn-reset { background:#8e8e93; color:#000; }
#timer { font-size:3em; text-align:center; padding:20px 0; font-variant-numeric:tabular-nums; }
#map { width:100%; height:300px; border-radius:12px; margin-top:10px; }
.flight-log-item { background:#2c2c2e; padding:15px; border-radius:8px; margin-bottom:10px; border-left:4px solid #667eea; }
.maintenance-item { background:#2c2c2e; padding:15px; border-radius:8px; margin-bottom:10px; }
.empty-state { text-align:center; padding:40px 20px; color:#8e8e93; }
</style>
</head>
<body>

<div class="header">
  <h1>✈️ Flight Tracker</h1>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('flight')">Flight</div>
  <div class="tab" onclick="switchTab('history')">History</div>
  <div class="tab" onclick="switchTab('maintenance')">Maintenance</div>
</div>

<!-- Flight Tab -->
<div id="flight" class="content active">
  <div class="card">
    <h3>Timer</h3>
    <div id="timer">00:00:00</div>
    <button class="btn btn-start" id="startBtn">Start</button>
    <button class="btn btn-stop" id="stopBtn">Stop</button>
    <button class="btn btn-reset" id="resetBtn">Reset</button>
  </div>

  <div class="card">
    <h3>Flight Details</h3>
    <div class="input-group">
      <label>Drone Type</label>
      <select id="droneType">
        <option value="">Select Drone</option>
        <option>DJI Mavic PT 30T #1</option>
        <option>DJI Mavic 3T #1.2</option>
        <option>DJI Mavic 3T #2.1</option>
        <option>DJI Mavic 3T #3</option>
        <option>DJI Mavic 3E #1</option>
        <option>DJI Mini 3 Pro #1</option>
        <option>DJI Mini 3 Pro #2</option>
        <option>DJI Avata Patrol #1</option>
        <option>Autel 640T V3 #1</option>
        <option>Skydio X2E</option>
        <option>DJI Matrice 4T-1</option>
        <option>DJI Matrice 4T-2</option>
        <option>DJI Matrice 4T-3</option>
        <option>Skyrover S1</option>
        <option>Skydio X10-1</option>
        <option>Skydio X10-2.2</option>
        <option>Skydio X10-3</option>
        <option>Skydio X10-4</option>
        <option>Skydio X10-5</option>
      </select>
    </div>

    <div class="input-group">
      <label>Location</label>
      <input type="text" id="location" placeholder="Auto-detected from GPS">
    </div>

    <div class="card">
      <h3>Map</h3>
      <div id="map"></div>
    </div>

    <div class="card">
      <h3>Weather</h3>
      <div id="weather">Loading...</div>
    </div>
  </div>

  <button class="btn btn-start" onclick="startFlight()">Save Flight</button>
</div>

<!-- History Tab -->
<div id="history" class="content">
  <div id="historyList"></div>
</div>

<!-- Maintenance Tab -->
<div id="maintenance" class="content">
  <div class="input-group">
    <label>Drone</label>
    <select id="maintDrone">
      <option value="">Select Drone</option>
      <option>DJI Mavic PT 30T #1</option>
      <option>DJI Mavic 3T #1.2</option>
      <option>DJI Mavic 3T #2.1</option>
      <option>DJI Mavic 3T #3</option>
      <option>DJI Mavic 3E #1</option>
      <option>DJI Mini 3 Pro #1</option>
      <option>DJI Mini 3 Pro #2</option>
      <option>DJI Avata Patrol #1</option>
      <option>Autel 640T V3 #1</option>
      <option>Skydio X2E</option>
      <option>DJI Matrice 4T-1</option>
      <option>DJI Matrice 4T-2</option>
      <option>DJI Matrice 4T-3</option>
      <option>Skyrover S1</option>
      <option>Skydio X10-1</option>
      <option>Skydio X10-2.2</option>
      <option>Skydio X10-3</option>
      <option>Skydio X10-4</option>
      <option>Skydio X10-5</option>
    </select>
  </div>
  <div class="input-group">
    <label>Maintenance Type</label>
    <input type="text" id="maintType" placeholder="Type">
  </div>
  <div class="input-group">
    <label>Notes</label>
    <textarea id="maintNotes" placeholder="Details"></textarea>
  </div>
  <button class="btn btn-primary" onclick="addMaintenance()">Save Maintenance</button>
  <div id="maintenanceList"></div>
</div>

<script>
let currentFlight = null;
let timerInterval = null;
let elapsed = 0;

// Tab switching
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
  if(tab==='history') renderHistory();
  if(tab==='maintenance') renderMaintenance();
}

// Timer functions
function pad(n){return n.toString().padStart(2,'0');}
function updateTimerDisplay(){
  let hrs=Math.floor(elapsed/3600);
  let mins=Math.floor((elapsed%3600)/60);
  let secs=elapsed%60;
  document.getElementById('timer').textContent=`${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
}
document.getElementById('startBtn').onclick=function(){if(!timerInterval)timerInterval=setInterval(()=>{elapsed++;updateTimerDisplay()},1000);};
document.getElementById('stopBtn').onclick=function(){clearInterval(timerInterval); timerInterval=null;};
document.getElementById('resetBtn').onclick=function(){clearInterval(timerInterval);timerInterval=null;elapsed=0;updateTimerDisplay();};

// Flight save
function startFlight(){
  let drone=document.getElementById('droneType').value;
  let loc=document.getElementById('location').value;
  if(!drone||!loc){alert('Select drone and location');return;}
  let flight={drone,location,time:elapsed,date:new Date().toLocaleString()};
  let flights=JSON.parse(localStorage.getItem('flights')||'[]');
  flights.push(flight);
  localStorage.setItem('flights',JSON.stringify(flights));
  alert('Flight saved!');
  elapsed=0;updateTimerDisplay();
}

// Render history
function renderHistory(){
  let flights=JSON.parse(localStorage.getItem('flights')||'[]');
  let html='';
  if(flights.length===0){html='<div class="empty-state">No flights logged</div>';}
  else{
    flights.forEach((f,i)=>{
      html+=`<div class="flight-log-item">
      <p><strong>Drone:</strong> ${f.drone}</p>
      <p><strong>Location:</strong> ${f.location}</p>
      <p><strong>Time:</strong> ${Math.floor(f.time/3600)}h ${Math.floor((f.time%3600)/60)}m ${f.time%60}s</p>
      <p><strong>Date:</strong> ${f.date}</p>
      <button onclick="deleteFlight(${i})">Delete</button>
      </div>`;
    });
  }
  document.getElementById('historyList').innerHTML=html;
}
function deleteFlight(i){
  let flights=JSON.parse(localStorage.getItem('flights')||'[]');
  flights.splice(i,1);
  localStorage.setItem('flights',JSON.stringify(flights));
  renderHistory();
}

// Maintenance
function addMaintenance(){
  let drone=document.getElementById('maintDrone').value;
  let type=document.getElementById('maintType').value;
  let notes=document.getElementById('maintNotes').value;
  if(!drone||!type||!notes){alert('Fill all fields'); return;}
  let record={drone,type,notes,date:new Date().toLocaleString()};
  let records=JSON.parse(localStorage.getItem('maintenance')||'[]');
  records.push(record);
  localStorage.setItem('maintenance',JSON.stringify(records));
  alert('Maintenance saved!');
  renderMaintenance();
}
function renderMaintenance(){
  let records=JSON.parse(localStorage.getItem('maintenance')||'[]');
  let html='';
  if(records.length===0){html='<div class="empty-state">No maintenance logs</div>';}
  else{
    records.forEach(r=>{
      html+=`<div class="maintenance-item">
      <p><strong>Drone:</strong> ${r.drone}</p>
      <p><strong>Type:</strong> ${r.type}</p>
      <p>${r.notes}</p>
      <p>${r.date}</p>
      </div>`;
    });
  }
  document.getElementById('maintenanceList').innerHTML=html;
}

// Map & weather
let map, marker;
function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{zoom:15});
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      let lat=pos.coords.latitude;
      let lng=pos.coords.longitude;
      let latlng=new google.maps.LatLng(lat,lng);
      map.setCenter(latlng);
      marker=new google.maps.Marker({position:latlng,map:map});
      // reverse geocode address
      let geocoder=new google.maps.Geocoder();
      geocoder.geocode({'location':latlng},function(results,status){
        if(status==="OK" && results[0]){
          document.getElementById('location').value=results[0].formatted_address;
        }
      });
      // weather
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`)
      .then(res=>res.json()).then(data=>{
        let w=data.current_weather;
        document.getElementById('weather').innerHTML=`Temp: ${w.temperature}°C, Wind: ${w.windspeed}km/h`;
      });
    });
  }
}
window.onload=()=>{
  renderHistory();
  renderMaintenance();
};
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB76-DcQwEsU4Q1S-aHKf11-VceYQnu5Zw&callback=initMap"></script>
</body>
</html>
